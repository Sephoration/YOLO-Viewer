

借鉴清晰的分隔注释
统一返回格式
加入Warm-up 
双视图

┌─────────────────┐    原始帧信号     ┌─────────────────┐
│                 ├──────────────────►│                 │
│   播放器线程     │                   │   推理器线程     │
│  (纯生产者)     │                   │  (消费者)       │
│                 │◄──────────────────┤                 │
└────────┬────────┘    结果信号       └─────────────────┘
         │ 显示帧信号
         ▼
┌─────────────────┐
│                 │
│    UI主线程     │◄─────────────────┐
│  (显示协调者)    │                   │
│                 │◄─────────────────┘
└─────────────────┘    叠加结果显示信号





过滤类别
类别过滤机制类别过滤机制

双视图设计双视图设计
批处理框架批处理框架


# YOLO多功能检测系统

## 📖 项目概述

Qt统一管理所有线程
是的，你的项目现在可以称为"基于QThread的架构"！

你已经：

✅ 解决了FFmpeg崩溃的核心问题

✅ 统一了业务逻辑的线程模型

✅ 获得了Qt线程管理的所有好处

✅ 保持了代码的简洁性

不需要为了"纯Qt线程"而过度设计。当前的架构是最佳实践：

业务逻辑用QThread

第三方库保持原样

UI在主线程

信号槽统一通信

你的项目现在是现代化、稳定、易维护的Qt多线程应用！🚀



**YOLO多功能检测系统**是一个基于PySide6和Ultralytics YOLO的跨平台计算机视觉应用程序。它提供了图像分类、目标检测、姿态估计和分割检测等多种计算机视觉任务的统一处理界面。系统采用模块化设计，支持实时视频流处理、批量图片检测和摄像头实时检测。

## 🚀 功能特性

### 🔍 核心功能
- **多任务支持**: 目标检测、图像分类、关键点检测（姿态估计）、分割检测
- **多源输入**: 支持图片、视频文件、摄像头实时流、批量图片文件夹
- **实时处理**: 流畅的视频流处理，支持播放控制和进度跳转
- **智能模型识别**: 自动检测YOLO模型类型并配置相应处理模式
- **参数实时调整**: 支持IOU阈值、置信度阈值、延迟时间等参数动态调整
- **结果可视化**: 检测结果实时叠加显示在图像上，支持中文字体渲染

### 🎨 用户界面
- **双面板设计**: 左侧显示区（4:3容器，16:9显示区域）+ 右侧控制面板
- **播放控制**: 视频播放/暂停、进度条拖动、时间显示
- **统计信息**: 实时显示检测数量、置信度、推理时间、FPS等
- **模型管理**: 模型信息显示、参数配置、推理控制
- **批量处理**: 支持图片文件夹批量检测，可配置显示时长

## 🏗️ 系统架构

### 模块化三分离架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    window_ui    │    │ logic_controller │    │  yolo_analyzer  │
│   (UI + 播放)   │◄──►│   (逻辑协调)    │◄──►│ (统一推理引擎)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐    ┌─────────────────┐
│ frame_grabber   │    │   baseDetect    │
│   (帧抓取器)    │    │   (基础类)      │
└─────────────────┘    └─────────────────┘
```

### 核心组件说明

#### 1. **window_ui.py** - 用户界面层
- **LeftDisplayPanel**: 左侧显示面板，支持16:9比例显示，包含播放控制
- **RightControlPanel**: 右侧控制面板，参数设置和统计信息显示
- **YOLOMainWindowUI**: 主窗口，集成工具栏和菜单

#### 2. **logic_controller.py** - 逻辑协调层
- **SimpleVideoPlayer**: 极简视频播放器，专注于流畅播放
- **YOLOMainController**: 主逻辑控制器，协调各组件工作
- 负责信号连接、状态管理、错误处理

#### 3. **yolo_analyzer.py** - 推理引擎层
- **UnifiedYOLO**: 统一YOLO处理器，整合三种处理模式
- 支持模型自动识别、延迟加载、统一接口
- 继承自baseDetect，提供标准化的画框方法

#### 4. **frame_grabber.py** - 数据抓取层
- **FrameGrabber**: 专门的帧抓取器，按需抓取视频帧
- 支持可配置的抓取频率，避免每帧都推理
- 分离播放和推理，保证播放流畅性

#### 5. **baseDetect.py** - 基础类
- 提供通用的参数配置和画框方法
- 颜色映射、字体设置、标签渲染

## 💻 技术栈

### 核心框架
- **PySide6 (Qt for Python)**: 跨平台GUI框架，提供现代UI组件
- **Ultralytics YOLO**: 业界领先的YOLO实现，支持多种任务
- **OpenCV**: 图像处理和计算机视觉库
- **PyTorch**: 深度学习框架，提供GPU加速

### 关键技术
- **多线程编程**: 播放、推理、UI更新分离，避免阻塞
- **信号槽机制**: Qt的松耦合组件通信
- **面向对象设计**: 清晰的类层次和职责分离
- **模块化架构**: 可扩展、可维护的组件设计

### 性能优化
- **延迟加载**: 模型在需要时才加载，减少启动时间
- **帧采样**: 按需抓取帧，平衡性能和准确性
- **内存优化**: 连续内存分配，避免不必要的拷贝
- **缓冲控制**: OpenCV缓冲区最小化，减少延迟

## 📦 安装部署

### 环境要求
- Python 3.8+
- CUDA 11.0+ (可选，用于GPU加速)
- 至少4GB RAM

### 安装步骤

1. **克隆仓库**
```bash
git clone <repository-url>
cd yolo-gui-project
```

2. **创建虚拟环境**
```bash
conda create -n yolo_gui python=3.8
conda activate yolo_gui
```

3. **安装依赖**
```bash
pip install PySide6 opencv-python ultralytics torch torchvision pillow numpy
```

4. **安装中文字体**
   - 将`SimHei.ttf`字体文件放置在项目根目录
   - 或修改代码中使用系统可用字体

5. **准备模型文件**
   - 在项目根目录创建`models/`文件夹
   - 将YOLO模型文件(.pt)放入该目录

### 目录结构
```
yolo-gui-project/
├── main.py                 # 程序入口
├── window_ui.py           # 用户界面
├── logic_controller.py    # 逻辑协调器
├── yolo_analyzer.py       # 统一YOLO引擎
├── frame_grabber.py       # 帧抓取器
├── baseDetect.py          # 基础检测类
├── SimHei.ttf            # 中文字体文件
├── models/               # 模型目录
│   ├── yolo11n.pt
│   ├── yolo11s-pose.pt
│   └── best.pt
├── images/               # 测试图片
├── videos/               # 测试视频
└── README.md             # 项目文档
```

## 🎮 使用指南

### 启动应用程序
```bash
python main.py
```

### 操作流程

#### 1. 加载模型
- 点击工具栏"加载模型"按钮
- 选择YOLO模型文件(.pt)
- 系统自动识别模型类型并显示信息

#### 2. 选择输入源
- **图片**: 点击"打开图片"，选择单张图片
- **视频**: 点击"打开视频"，选择视频文件
- **摄像头**: 点击"打开摄像头"，使用默认摄像头
- **文件夹**: 在图片模式下，使用批量控制按钮

#### 3. 配置参数
- **IOU阈值**: 调整检测框重叠度 (0.0-1.0)
- **置信度**: 过滤低置信度结果 (0.0-1.0)
- **延迟(ms)**: 控制处理间隔，影响实时性
- **线宽**: 调整检测框和关键点的绘制线宽

#### 4. 开始检测
- 点击"开始"按钮启动推理
- 实时查看检测结果和统计信息
- 使用播放控制按钮管理视频流

#### 5. 保存结果
- 点击"保存截图"保存当前画面
- 图片处理结果可手动保存

### 快捷键
- **播放/暂停**: 点击播放按钮或使用快捷键
- **退出**: 窗口关闭按钮或Ctrl+Q
- **进度跳转**: 拖动进度条

## 🔧 模型支持

### 支持的YOLO模型类型
- **目标检测**: YOLOv5, YOLOv8, YOLOv11检测模型
- **图像分类**: YOLO分类模型  
- **姿态估计**: YOLO关键点检测模型
- **分割检测**: YOLO分割模型

### 模型命名约定
系统根据模型文件名自动识别类型：
- `*det*.pt` - 目标检测模型
- `*cls*.pt` - 分类模型  
- `*pose*.pt` - 姿态估计模型
- `*seg*.pt` - 分割模型

### 自定义模型
支持自定义训练的YOLO模型，确保：
1. 使用Ultralytics框架训练
2. 导出为.pt格式
3. 类别标签正确配置

### 关键点检测配置文件

#### 配置文件格式
系统支持为关键点检测模型提供JSON配置文件，用于自定义可视化参数。配置文件与模型文件同名，例如 `model.pt` 对应 `model.json`。

#### 配置文件示例
```json
{
  "model_info": {
    "name": "Triangle_215_yolo11s_pretrain",
    "keypoint_count": 3
  },
  "bbox": {
    "color": [150, 0, 0],
    "thickness": 2,
    "label": {
      "font_size": 0.5,
      "font_thickness": 1,
      "offset_x": 0,
      "offset_y": -10
    }
  },
  "keypoints": {
    "0": {
      "name": "angle_30",
      "color": [255, 0, 0],
      "radius": 3
    },
    "1": {
      "name": "angle_60",
      "color": [0, 255, 0],
      "radius": 3
    },
    "2": {
      "name": "angle_90",
      "color": [0, 0, 255],
      "radius": 3
    }
  },
  "keypoint_label": {
    "font_size": 0.4,
    "font_thickness": 1,
    "offset_x": 5,
    "offset_y": 5
  },
  "visualization": {
    "show_keypoint_names": true,
    "show_skeleton": false,
    "show_bbox": true
  }
}
```

#### 配置项说明
- **bbox**: 边界框可视化配置
- **keypoints**: 关键点配置，包含名称、颜色、半径
- **keypoint_label**: 关键点标签配置
- **visualization**: 可视化控制，包括是否显示关键点名称、骨架连接、边界框

### 检测设置界面

系统新增了检测设置界面，可通过工具栏"检测设置"按钮访问。支持实时调整：
- 显示/隐藏关键点名称
- 显示/隐藏骨架连接
- 显示/隐藏边界框

这些设置会实时应用到检测结果上，无需重新加载模型。

## 🚀 性能优化

### 硬件加速
- **GPU加速**: 自动检测CUDA可用性，优先使用GPU
- **多线程**: 播放、推理、UI更新分离线程
- **内存管理**: 及时释放不用的资源

### 软件优化
- **帧采样**: 可配置的抓取间隔，避免每帧推理
- **模型缓存**: 模型只需加载一次
- **图像转换优化**: 减少不必要的颜色空间转换

### 配置建议
- **高性能模式**: 降低抓取间隔，提高检测频率
- **平衡模式**: 默认设置，平衡性能和资源使用
- **节能模式**: 增加抓取间隔，减少计算负载

## 🐛 故障排除

### 常见问题

#### 1. 导入错误
```bash
# 确保所有依赖已安装
pip install -r requirements.txt

# 检查Python路径
python --version
```

#### 2. 模型加载失败
- 检查模型文件路径是否正确
- 确认模型格式为.pt
- 查看控制台错误信息

#### 3. 视频播放卡顿
- 降低抓取间隔参数
- 检查硬件性能
- 关闭其他占用资源的程序

#### 4. 中文字体显示异常
- 确保SimHei.ttf文件存在
- 修改代码使用系统字体
- 检查字体文件完整性

### 调试模式
```bash
# 启用详细日志
python main.py --debug

# 查看具体错误信息
# 检查控制台输出
```

## 📈 扩展开发

### 添加新功能
1. **新的检测模式**: 继承`UnifiedYOLO`类
2. **UI组件**: 在`window_ui.py`中添加
3. **业务逻辑**: 在`logic_controller.py`中实现

### 代码结构扩展
```python
# 添加新的处理模式
class NewYOLOMode(UnifiedYOLO):
    def _process_new_mode(self, frame):
        # 实现新模式的逻辑
        pass

# 在UI中添加新控件
class ExtendedRightPanel(RightControlPanel):
    def _create_new_controls(self):
        # 添加新的控制组件
        pass
```

### 接口说明
- **process_frame()**: 统一处理接口，返回标准化结果字典
- **信号槽机制**: 使用Qt信号进行组件间通信
- **配置管理**: 通过参数字典传递配置

## 📚 开发指南

### 代码规范
- **PEP 8**: 遵循Python编码规范
- **类型提示**: 使用类型注解提高代码可读性
- **文档字符串**: 为所有函数和类添加文档
- **错误处理**: 全面的异常捕获和处理

### 测试建议
```python
# 单元测试示例
def test_yolo_processor():
    processor = UnifiedYOLO("models/test.pt")
    result = processor.process_frame(test_image)
    assert result['success'] == True
    assert 'stats' in result
```

### 版本控制
- 使用Git进行版本管理
- 遵循语义化版本控制
- 详细的提交信息

## 🤝 贡献指南

### 提交问题
1. 在Issues中描述问题
2. 提供复现步骤
3. 附上错误日志

### 提交代码
1. Fork仓库
2. 创建功能分支
3. 提交Pull Request
4. 通过代码审查

### 开发环境设置
```bash
# 设置开发环境
git clone <repo-url>
cd yolo-gui
pip install -e .[dev]

# 运行测试
pytest tests/

# 代码格式化
black .
flake8 .
```

## 📄 许可证

本项目采用MIT许可证。详见LICENSE文件。

## 🙏 致谢

- **Ultralytics团队**: 提供优秀的YOLO实现
- **Qt/PySide6团队**: 强大的跨平台GUI框架
- **OpenCV社区**: 计算机视觉基础库
- **所有贡献者**: 感谢你们的代码和反馈

## 📞 支持与联系

- **问题反馈**: [GitHub Issues](https://github.com/your-repo/issues)
- **功能请求**: 通过Issues提交
- **技术讨论**: [Discussions](https://github.com/your-repo/discussions)

---

**© 2024 YOLO多功能检测系统项目组**  
*让计算机视觉更加触手可及*